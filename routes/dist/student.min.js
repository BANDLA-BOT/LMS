"use strict";function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var router=require("express").Router(),validate=require("../config/verifyToken.js"),path=require("path"),jwt=require("jsonwebtoken"),_require=require("../models/registrationModel.js"),registerModel=_require.registerModel,courseModel=_require.courseModel,studentModel=_require.studentModel,multer=require("multer"),storage=multer.diskStorage({destination:function(e,r,t){t(null,"public/profile")},filename:function(e,r,t){t(null,Date.now()+"-"+path.extname(r.originalname))}}),upload=multer({storage:storage}).single("profile");router.post("/register",upload,function(r,t){var s,n,a,o,u,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body,n=s.username,a=s.email,o=s.password,u=r.file.profile,i=new studentModel({username:n,password:o,email:a,profile:u}),e.next=6,regeneratorRuntime.awrap(i.save());case 6:t.json({message:"Student registered successfully ",StudenDetails:i}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),t.json({error:e.t0.message});case 12:case"end":return e.stop()}},null,null,[[0,9]])}),router.post("/login",function(r,t){var s,n,a,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body,n=s.email,a=s.password,e.next=4,regeneratorRuntime.awrap(studentModel.findOne({email:n,password:a}));case 4:(o=e.sent)?(u=jwt.sign({user:{username:o.username,email:o.email,password:o.password,id:o._id,profile:o.profile}},process.env.SECRET_KEY,{expiresIn:"1h"}),t.json({message:"Student logged in successfully",student:o,token:u})):o||t.json({message:"No student found"}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),t.json({message:"Error while login",error:e.t0});case 11:case"end":return e.stop()}},null,null,[[0,8]])}),router.post("/purchase/:courseId/:studentId",validate,function(r,t){var s,n,a,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params,n=s.courseId,a=s.studentId,e.next=4,regeneratorRuntime.awrap(studentModel.findById(a));case 4:return o=e.sent,console.log(o),e.next=8,regeneratorRuntime.awrap(courseModel.findById(n));case 8:if(u=e.sent,o&&u){e.next=11;break}return e.abrupt("return",t.status(400).json({message:"User/Course not found "}));case 11:return o.purchases.push(u),e.next=14,regeneratorRuntime.awrap(o.save());case 14:t.status(200).json({message:"Course added to user ",student:o}),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",err:e.t0.message});case 20:case"end":return e.stop()}},null,null,[[0,17]])}),router.get("/profile",validate,function(r,t){var s,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.user,console.log(s),e.next=4,regeneratorRuntime.awrap(courseModel.find());case 4:n=e.sent,t.json({message:"Courses available are",courses:n});case 6:case"end":return e.stop()}})}),router.get("/categories",validate,function(r,t){var s,n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.user,console.log(s),e.next=4,regeneratorRuntime.awrap(courseModel.find({coursetype:"free"}));case 4:return n=e.sent,e.next=7,regeneratorRuntime.awrap(courseModel.find({coursetype:"paid"}));case 7:a=e.sent,t.json({message:"fetched",user:s,FreeCourses:n,PaidCourses:a});case 9:case"end":return e.stop()}})}),router.put("/update/:id",function(r,t){var s,n,a,o,u,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.body,n=s.email,a=s.password,o=s.username,u=r.params.id,e.next=4,regeneratorRuntime.awrap(registerModel.updateOne({_id:u},{$set:{email:n,password:a,username:o}}));case 4:i=e.sent,t.json({message:"updated successfully",user:i});case 6:case"end":return e.stop()}})}),router.get("/search/filter",function(r,t){var s,n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.query.q,e.next=4,regeneratorRuntime.awrap(courseModel.find({$or:[{coursename:{$regex:s,$options:"i"}}]}));case 4:return n=e.sent,e.next=7,regeneratorRuntime.awrap(registerModel.find({$or:[{username:{$regex:s,$options:"i"}}]}));case 7:a=e.sent,t.json({message:"found results",Courses:n,instructor:a}),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),t.status(500).json({message:"Error While searching",error:e.t0});case 14:case"end":return e.stop()}},null,null,[[0,11]])}),router.post("/wishlist/:courseId/:studentId",validate,function(r,t){var s,n,a,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params,n=s.courseId,a=s.studentId,e.next=4,regeneratorRuntime.awrap(studentModel.findById({_id:a}));case 4:return o=e.sent,e.next=7,regeneratorRuntime.awrap(courseModel.findById({_id:n}));case 7:return u=e.sent,console.log(o,u),o.wishlist.push(u),e.next=12,regeneratorRuntime.awrap(o.save());case 12:t.json({message:"wishlist created ",student:o}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),t.json(_defineProperty({error:e.t0.message},"error","Error occured while creating wishlist"));case 18:case"end":return e.stop()}},null,null,[[0,15]])}),router.get("/getwishlist",validate,function(r,t){var s,n,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.user.user,n=s.email,a=s.password,e.next=3,regeneratorRuntime.awrap(studentModel.find({email:n,password:a}));case 3:o=e.sent;try{o[0].wishlist.length||t.json({message:"There are no courses in your wishlist"}),t.json({message:"Wishlist found",list:o[0].wishlist})}catch(e){}case 5:case"end":return e.stop()}})}),router.put("/certification/:courseId/:completed",validate,function(r,t){var s,n,a,o,u,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.params,n=s.courseId,a=s.completed,o=r.user,u=o.user,u.email,u.password,e.prev=3,e.next=6,regeneratorRuntime.awrap(studentModel.findOneAndUpdate({email:o.user.email,password:o.user.password,"purchases._id":n},{$set:{"purchases.$.completed":a}},{new:!0}));case 6:if(i=e.sent){e.next=9;break}return e.abrupt("return",t.status(404).json({message:"Student or course not found"}));case 9:t.json(i),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(3),t.status(500).json({message:e.t0.message});case 15:case"end":return e.stop()}},null,null,[[3,12]])}),router.get("/getcertificate",validate,function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(studentModel.aggregate([{$unwind:"$purchases"},{$match:{"purchases.completed":!0}},{$group:{_id:"$_id",email:{$first:"$email"},username:{$first:"$username"},completedPurchases:{$push:"$purchases"}}}]));case 3:t=e.sent,r.json(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({message:"Error fetching completed purchases",error:e.t0});case 10:case"end":return e.stop()}},null,null,[[0,7]])}),module.exports=router;
//# sourceMappingURL=student.min.js.map
